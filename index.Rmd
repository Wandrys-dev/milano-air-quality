---
title: "Milano Air Quality Dashboard"
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
editor_options: 
  chunk_output_type: console
---

```{r, include=FALSE}
# https://www.eea.europa.eu/themes/air/air-quality-concentrations/AirQlimitvalues.png
# https://environment.ec.europa.eu/topics/air/air-quality/eu-air-quality-standards_en
# https://dati.comune.milano.it/dataset/ds573-valori-rilevati-per-i-principali-inquinanti-dell-aria
```


```{r, include=FALSE}
library(tidyverse)
library(here)
library(tsibble)
library(lubridate)
library(ggiraph)
```

```{r, include=FALSE}
theme_set(
  theme_minimal() +
    theme(
      axis.text.x = element_text(
        angle = 90,
        vjust = 0,
        hjust = 1
      ),
      axis.text.y = element_text(
        vjust = 0,
        hjust = 1 
      ),
      axis.title.y = element_text(
        hjust = 1
      )
    ) 
)

thin_line <- .2
medium_line <- .5
limits_colour <- 'red'
def_colour <- 'blue'
mid_colour <- 'grey50'
loess_span <- .2 # span should increase during the year
ozone_limits <- 120
```

```{r}
breaks_on_fortnight <- function(x) {
  n_days <- 14
  d <- seq.Date(from = min(x),
                to = max(x) + days(n_days - 1),
                by = n_days)
  return(d - days(n_days - 1))
}
```

```{r, include=FALSE}  
air_q_url <-
  'data/e1cc82ec-97bb-463c-a3fb-b61be60f0956.csv'

air_q <- 
  air_q_url %>% 
  readr::read_csv() %>% 
  janitor::clean_names() %>% 
  rename(date = data) %>% 
  mutate(date = date %>% as_date())

air_q_o3 <- 
  air_q %>% 
  filter(inquinante == 'O3') 

```

```{r}
p1 <- 
  air_q_o3 %>% 
  ggplot(
    aes(
      x = date,
      y = valore,
    )
  ) +
  geom_hline(yintercept = 0) +
  geom_hline(yintercept = ozone_limits,
             colour = mid_colour,
             size = thin_line, 
             lty = '1212')  +
  geom_smooth(size = medium_line,
              colour = '#00000000',
              method = 'loess',
              span = loess_span) +
  geom_point_interactive(
    aes(tooltip = glue::glue('Data: {date}\nValore: {valore}'),
        colour = after_stat(y)),
    size = 1,
    alpha = .8) +
  scale_colour_gradient2_interactive(
    low = def_colour,
    mid = mid_colour,
    high = limits_colour,
    midpoint = ozone_limits
  ) +
  scale_x_date(
    breaks = breaks_on_fortnight,
    minor_breaks = NULL,
    expand = expansion(mult = c(.01, .1)),
    date_labels = '%b %d'
  ) +
  guides(colour = 'none') +
  labs(x = '',
       y = 'Concentration [Âµg/m3]')

girafe(
  ggobj = p1,
  height_svg = 3,
  pointsize = 10,
  options = list(
    opts_sizing(rescale = TRUE, width = 1)
  ))
```


